---
layout: post
title:  "使用Windows Server做软路由"
subtitle: '软路由'
date:   2022-07-04
tags: 软路由
description: 'WIN软路由'
color: 'rgb(154,133,255)'
cover: '../assets/winsrv-j3160.png'
---

# Windows server 2022 配置软路由

![image-20220704170127825](\assets\2022-7-4\image-20220704170127825.png)

系统采用 Microsoft Windows Server 2022来进行设置，**安装操作系统，配置远程访问等略过**

## 添加角色和功能

打开`服务器管理器`，在右上角点击`管理`，选中`添加角色和功能`

![image-20220704170818820](\assets\2022-7-4\image-20220704170818820.png)

![image-20220704171152019](\assets\2022-7-4\image-20220704171152019.png)

点击`下一步`，选择`基于角色或功能的安装`，点击`下一步`，选择`从服务器池中选择服务器`，选中当前需要设置的服务器后点击`下一步`

![image-20220704171738836](\assets\2022-7-4\image-20220704171738836.png)

勾选DHCP服务器、DNS服务器、远程访问DirectAccess和VPN（RAS），点击下一步

![image-20220704174552334](\assets\2022-7-4\image-20220704174552334.png)

在功能中选择`无线LAN服务`，远程服务器管理工具中选择`DHCP服务器工具`和`DNS服务器工具`，选择安装，安装完成后根据提示进行重启

![image-20220704175728254](\assets\2022-7-4\image-20220704175728254.png)![image-20220704175823912](\assets\2022-7-4\image-20220704175823912.png)

# 路由和远程访问

> 注意！如果你的无线网卡不是PCIE（内置），你是使用usb无线网卡作为ap，那么你应该首先启用承载网络，win server中无法直接打开承载网络，也就是win 用户系统中的热点共享，若你使用独立ap，通过RJ45网线进行使用WIFI功能，那么可以忽略此提示，并跳转到路由设置。

## WIFI设置

若你的无线网卡为USB，首先需要查看你的USB无线网卡是否支持承载网络和软ap，若支持，请在网卡的驱动设置里，启用ap模式

![image-20220704180838843](\assets\2022-7-4\image-20220704180838843.png)

如何查看是否支持软ap和承载网络：

打开CMD窗口，输入 `netsh wlan show all`，在显示驱动程序中可以查看是否支持承载的网络，在显示接口功能一栏中可以看到此网卡是否支持软ap

![image-20220704181141549](\assets\2022-7-4\image-20220704181141549.png)

![image-20220704181404065](\assets\2022-7-4\image-20220704181404065.png)

## 开启承载网络

进入CMD窗口，输入`netsh wlan set hostednetwork mode=allow ssid=xxx key=xxx`其中，mode为指定允许还是禁止托管网络，ssid为你的无线网（WIFI）的名称，key为你的无线网密码

该命令成功执行后，此时输入WIN+R键，输入ncpa.cpl或者在控制面板中选择网络和Internet->网络连接，可以看到网络设备中多出一个本地连接*xx，名称为Microsoft Hosted Network Virtual Adapter...那么承载网络已成功添加，但是还是无法进行设备连接，此时，在CMD窗口中，输入`netsh wlan start hostednetwork`即可启用承载网络，当承载网络启用后，此WIFI才可被扫描到

## 路由设置

打开服务器管理器，点击左上角的工具，选择路由和远程访问，

![image-20220704180211997](\assets\2022-7-4\image-20220704180211997.png)

> 若你在配置承载网络之前就启用了路由和远程访问服务，那么可能会出现网络接口中没有此虚拟网卡的情况，那么需要你先禁止路由和远程访问服务，先启用承载网络后再启用路由和远程访问服务

[如何设置路由和远程访问 - Windows Server | Microsoft Docs](https://docs.microsoft.com/zh-cn/troubleshoot/windows-server/networking/set-up-routing-remote-access-intranet)

![image-20220704182854203](\assets\2022-7-4\image-20220704182854203.png)

点击配置并启用路由和远程访问，选择自定义配置，在自定义配置中将选项全选，在弹出的提示框中点击确定，等待服务运行

服务运行后，可以点击左侧网络接口查看当前接口信息，其中名为**本地连接*12**为虚拟网卡，也就是作为AP的必要接口

![image-20220704183043206](\assets\2022-7-4\image-20220704183043206.png)

打开左侧IPv4，右键选择NAT，点击新增接口，将所有接口都添加上去

> 为了方便起见，请将你的WAN口网卡名称修改为WAN，LAN口网卡修改为LAN，指定WAN口或者是LAN口网卡没有特殊要求，只需要将你想设置成WAN口或者LAN口的网络适配器修改名称，方便后续操作。

添加完接口后，选中你想设置为WAN口的接口，双击打开设置界面，选择公用接口连接到Internet，并勾选在此接口上启用NAT，其余接口全部设置成专用接口连接到专用网络

![image-20220704183806546](\assets\2022-7-4\image-20220704183806546.png)

![image-20220704183818722](\assets\2022-7-4\image-20220704183818722.png)

设置完以上步骤后，路由就已经设置完成，但是还没有实现软路由的DHCP功能

# 网卡IP配置

## WAN网卡IP配置

WAN网卡IP是通往Internet的接口，那么在IPV4设置中选择自动获取IP地址

![image-20220704184111186](\assets\2022-7-4\image-20220704184111186.png)

## LAN网卡IP配置

LAN口为此软路由的下级设备，那么LAN口应作为此软路由的有线网关，在IPV4设置中选择使用下面的IP地址，IP地址填写192.168.1.1子网掩码为255.255.255.0，默认网关不填，DNS服务器地址填写192.168.1.1，192.168.1.1也可自行设置，但不能与局域网中的IP地址冲突，否则会造成网络环路，网络拓扑等严重错误，可能会使整个网络瘫痪，无法使用

## AP网卡IP配置

AP网卡的IP配置跟LAN网卡一样，这里配置成192.168.137.1，掩码依旧为255.255.255.0，默认网关不填，DNS填写192.168.137.1，也可不填，填LAN口网关也可

# DHCP配置

上面都配置好后，即使插上网线，连接到AP，可以发现我们无法自动获取到IP地址，那么你可以手动填写IP信息，但是过于麻烦，那么我们现在配置DHCP服务器让DHCP下发IP地址

依旧是在服务器管理器中，点击左上角的工具，打开DHCP

![image-20220704210347498](\assets\2022-7-4\image-20220704210347498.png)

打开后点击此服务器，打开IPv4，没有配置的情况下没有图中的2个作用域，需要自己添加

![image-20220704210440577](\assets\2022-7-4\image-20220704210440577.png)

右键IPv4，选择新建作用域

![image-20220704210555286](\assets\2022-7-4\image-20220704210555286.png)

在新建作用域向导中点击下一步，设置一个名称，设置完成后点击下一步，在IP地址范围中选填写起始IP和结束IP，长度自动生成

![image-20220704210800380](\assets\2022-7-4\image-20220704210800380.png)

> 注意，DHCP的地址范围不包括网关和广播地址，因为此分配的地址作为网络设备的IP地址，如果包括了网关的IP地址，那么就有可能网络设备被分配成网关的地址，会出现错误，并且IP地址范围必须保证在一个网段内，比如192.168.1.0这个网段，192.168.1.1作为网关地址 192.168.1.255作为广播地址，广播地址不可变，故DHCP的地址范围只能由192.168.1.2-192.168.1.254，如果有子网划分，那么又是另一种分发，不过一般软路由不需要这么复杂的配置，253个IP地址足够使用
>
> 当然，网关地址是可以改变的，为了配置的方便，网关一般选取首地址。

填写完成后点击下一步，添加排除和延迟可以不填，租用期限可以默认，然后选择是，我想现在配置这些选项，点击下一步

在路由器（默认网关）中，IP地址填写网关地址，比如我们配置192.168.1.0这个网段的DHCP，那么网关地址可以填写192.168.1.1，填写完后点击添加

![image-20220704211645797](\assets\2022-7-4\image-20220704211645797.png)

下一步配置DNS服务器，DNS服务器若你没有上级路由，那么就填写你的网关地址作为DNS服务器，点击添加后，系统会提示验证此DNS服务器，由于是添加的本地网关作为DNS服务器，那么会提示此地址不是有效的DNS地址，这个不用管，点击是

![image-20220704211837884](\assets\2022-7-4\image-20220704211837884.png)

点击下一步后，配置WINS服务器，同DNS服务器一致，也填写网关地址，点击下一步，然后选择是，我想现在激活此作用域

那么LAN口（192.168.1.1）的DHCP功能就做好了，但是要想使用WIFI功能，还需要给AP网卡配置DHCP，AP的DHCP配置同LAN口一样，本文中AP的网段设置为192.168.137.0，那么网关选取为192.168.137.1 其他设置均同上，配置一个192.168.137.0的DHCP服务器，那么就可以正常使用DHCP下发IP地址的功能了

# 完成配置

至此，我们已经配置完成一个软路由所需要的基础功能了。
